#!/usr/bin/env php
<?php

if (
    (!@include __DIR__.'/../../.composer/autoload.php')
    && (!@include __DIR__.'/vendor/.composer/autoload.php')
) {
    die('You must set up the project dependencies, run the following commands:'
            ."\n".
        'curl -s http://getcomposer.org/installer | php'."\n".
        'php composer.phar install'."\n");
}

use Phpsog\Application;
use Phpsog\Exporter;
use Phpsog\Logger;
use Symfony\Component\EventDispatcher\EventDispatcher;
use Kaloa\Filesystem\PathHelper;
use Phpsog\ExportEvent;

try {
    $params = array(
        'config' => ''
    );

    $dispatched = false;

    if ($_SERVER['argc'] !== 2) {
        throw new Exception('Wrong argument count');
    } else {
        if ($_SERVER['argv'][1] === '--version') {
            echo 'phpsog ' . Application::VERSION . "\n";
            $dispatched = true;
        } else {
            $params['config'] = $_SERVER['argv'][1];
        }
    }

    if (!$dispatched) {
        if (is_dir($params['config'])) {
            $params['config'] .= '/phpsog.ini';
        }

        $ph         = new PathHelper();
        $dispatcher = new EventDispatcher();
        $exporter   = new Exporter($ph, $dispatcher);
        $logger     = new Logger();
        $adapt = function (ExportEvent $event) use ($logger) {
            $logger->onExport($event);
        };
        $dispatcher->addListener('onExport', $adapt);
        $dispatcher->addListener('onMkdir', $adapt);

        $exportCounter = 0;
        $mkdirCounter = 0;

        $dispatcher->addListener('onExport', function () use (&$exportCounter) {
            $exportCounter++;
        });
        $dispatcher->addListener('onMkdir', function () use (&$mkdirCounter) {
            $mkdirCounter++;
        });

        $phpsog     = new Application($exporter, $ph);

        $phpsog->loadConfig($params['config']);

        $phpsog->sanitizeEnvironment();

        $phpsog->processHtmlProvider();
        $phpsog->processResources();

        $logger->log("\n" . 'Event count:    Export: ' . $exportCounter
                . '    Mkdir: ' . $mkdirCounter);
    }
} catch (Exception $e) {
    die('Error: ' . $e->getMessage() . "\n");
}
